{% extends "layouts/default.html" %}

{% block content %}
<div class="container-fluid mt-3">
	<div class="row">
		<div class="col-md-8 text-center">
			{% if stocks.length > 0 %}
			<canvas id="myChart" class="mb-3"></canvas>
			{% else %}
			<div class="mt-3 mb-3">
				<h3>No Active Stocks</h3>
				<p>No one has added a stock yet. Please add a stock from the stock picker.</p>
			</div>
			{% endif %}
		</div>
		<div class="col-md-4">
			<h3>Tracking Stocks</h3>
			{% for stock in stocks %}
			<div class="mb-1">
				<i class="fa fa-times fa-fw ml-1 text-danger remove-stock" data-id="{{ stock._id }}"></i>
				{{ stock.stockName }}
			</div>
			{% endfor %}
			<hr>
			<h3>Add a Stock</h3>
			<form id="stockForm">
				<div class="form-group">
					<input id="stock" type="text" name="stock" value="" placeholder="Ex. GOOG" class="form-control">
				</div>
				<div class="form-group">
					<input type="submit" name="button" value="Add a Stock" class="btn btn-primary form-control">
				</div>
			</form>
		</div>
	</div>
</div>
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
/* -- Stock Manager -- */
$(function(){
	var socket = io.connect();

	$('#stockForm').on('submit', function(e) {
		e.preventDefault();
		var stockName = $('#stock').val();
		$.ajax({
			method: "POST",
			url: "/stocks/" + stockName,
			data: {},
			dataType: 'json',
			success: function() {
				socket.emit('add stock', data.stockName);
			},
			error: function(error) {
				alert('That doesn\'t look like a valid stock symbol!');
			}
		});
	});

	socket.on('stock added', function(data){
		location.reload();
	});

	$(".remove-stock").on("click", function(e) {
		var stockId = $(this).data('id');

	    $.ajax({
	        method: "DELETE",
	        url: "/stocks/" + stockId,
			data: {},
	        dataType: 'json',
	        success: function() {
				socket.emit('remove stock', stockId);
	        },
	        error: function(error) {
	            alert('Something went wrong, please try again!');
	        }
	    });
	});

	socket.on('stock removed', function(data){
		location.reload();
	});
});
</script>

<script type="text/javascript">
/* -- Chart -- */
var data = {{ stocks | dump | safe }};

function createHex() {
    return '#' + Math.floor(Math.random() * 16777215).toString(16);
}

var datasets = [];
data.forEach(function(stock, index){
	var color = createHex();
	datasets.push({
        label: stock.stockName,
		fill: false,
		lineTension: 0.1,
		backgroundColor: color,
		borderColor: color,
		borderCapStyle: 'butt',
		borderDash: [],
		borderDashOffset: 0.0,
		borderJoinStyle: 'miter',
		pointBorderColor: color,
		pointBackgroundColor: "#fff",
		pointBorderWidth: 1,
		pointHoverRadius: 5,
		pointHoverBackgroundColor: color,
        data: stock.data.map(element => element.value)
    })
});

var ctx = document.getElementById('myChart').getContext('2d');
var data = {
    labels: data[0].data.map(element => element.date),
    datasets: datasets
};

var myLineChart = new Chart(ctx, {
    type: 'line',
    data: data
});
</script>
{% endblock %}
